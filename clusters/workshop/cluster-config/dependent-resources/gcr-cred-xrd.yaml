apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xgcrcredentials.se.tanzu.vmware.com
spec:
  compositeTypeRef:
    apiVersion: se.tanzu.vmware.com/v1alpha1
    kind: XGcrCredential
  publishConnectionDetailsWithStoreConfigRef:
    name: default
  resources:
    - name: google-serviceaccount
      base:
        apiVersion: cloudplatform.gcp.upbound.io/v1beta1
        kind: ServiceAccount
        spec:
          forProvider: {}
      patches:
      - type: CombineFromComposite
        toFieldPath: spec.forProvider.description
        policy:
          fromFieldPath: Required
        combine:
          variables:
            - fromFieldPath: spec.claimRef.namespace
            - fromFieldPath: spec.claimRef.name
          strategy: string
          string:
            fmt: "WaaS Cluster claim %s/%s"
    - name: google-serviceaccount-key
      base:
        apiVersion: cloudplatform.gcp.upbound.io/v1beta1
        kind: ServiceAccountKey
        spec:
          forProvider:
            publicKeyType: TYPE_X509_PEM_FILE
            serviceAccountIdSelector:
              matchControllerRef: true
          publishConnectionDetailsTo:
            metadata:
              type: kubernetes.io/dockerconfigjson
      connectionDetails:
        - fromConnectionSecretKey: private_key
      patches:
      - fromFieldPath: metadata.uid
        toFieldPath: spec.publishConnectionDetailsTo.name
        transforms:
        - string:
            fmt: '%s-serviceaccountkey'
            type: Format
          type: string
        type: FromCompositeFieldPath
---
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xgcrcredentials.se.tanzu.vmware.com
spec:
  group: se.tanzu.vmware.com
  names:
    kind: XGcrCredential
    plural: xgcrcredentials
  claimNames:
    kind: GcrCredential
    plural: gcrcredentials
  connectionSecretKeys:
  - private_key
  versions:
  - name: v1alpha1
    served: true
    referenceable: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              parameters:
                type: object
            required:
            - parameters

